image: docker:latest
services:
  - docker:dind

variables:
  DOCKER_DRIVER: overlay
  SPRING_PROFILES_ACTIVE: gitlab-ci

stages:
  - build
  - package
  - deploy

maven-war-compile:
   stage: build
   image: maven:3-jdk-8
   script: "mvn package -B"
   artifacts:
     paths:
       - target/*.war

docker-build:
  stage: package
  script:
    - docker-compose up --build
    - docker login myacrfitec.azurecr.io -u $ACR_USER -p $ACR_PASSWORD
    - docker tag petclinicfitec_petclinic-app myacrfitec.azurecr.io/petclinicfitec-app:latest
    - docker push myacrfitec.azurecr.io/petclinicfitec-app:latest

azure-deploy:
  stage: deploy
  image: microsoft/azure-cli
  script:
        - az aks get-credentials --resource-group=kubcluster --name=akcpetclinic
        - kubectl run test-app --image=petcliniccr.azurecr.io/petclinicfitec_petclinic-app:latest
        - kubectl expose deployment test-app --type=LoadBalancer --port=80 --target-port=8080
#unit-test:
#  stage: Test
#  script:
#    - npm test

